<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Recognition Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        video { width: 100%; border-radius: 8px; background: black; margin-bottom: 15px; transform: scaleX(-1); }
        button { background: #007bff; color: white; border: none; padding: 18px 30px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin: 15px 0; padding: 12px; border-radius: 8px; font-weight: 500; font-size: 0.9em; }
        .status.loading { background: #e3f2fd; color: #1565c0; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        #result { margin-top: 20px; text-align: left; display: none; }
        .result-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 5px solid #007bff; }
    </style>
</head>
<body>

<div class="container">
    <h1>Date Scanner</h1>
    <div id="status" class="status loading">System initializing...</div>
    <div style="position: relative;"><video id="video" autoplay playsinline muted></video></div>
    <button id="scanBtn" disabled>START CAMERA EERST</button>
    <div id="result"><div class="result-box" id="resultContent"></div></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const TM_MODEL_URL = "https://teachablemachine.withgoogle.com/models/hgp4ntk2z/";
    const GEMINI_API_KEY = "AIzaSyCO2VXgEzZyE7ox-eXeTwP5VIb79w3eKp8"; 

    // LIJST MET MODELLEN OM TE PROBEREN (Als de eerste faalt, pakt hij de volgende)
    const MODEL_NAMES = [
        "gemini-1.5-flash",
        "gemini-1.5-flash-001",
        "gemini-1.5-flash-002",
        "gemini-1.5-pro"
    ];

    let tmModel, videoEl = document.getElementById('video');
    let statusEl = document.getElementById('status');
    let scanBtn = document.getElementById('scanBtn');
    let resultDiv = document.getElementById('result');
    let resultContent = document.getElementById('resultContent');

    function setStatus(msg, type='loading') {
        statusEl.textContent = msg;
        statusEl.className = `status ${type}`;
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }

    async function init() {
        try {
            setStatus("Loading AI Models...");
            tmModel = await tmImage.load(TM_MODEL_URL + 'model.json', TM_MODEL_URL + 'metadata.json');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            videoEl.srcObject = stream;
            
            scanBtn.disabled = false;
            scanBtn.textContent = "SCAN PRODUCT";
            setStatus("Ready. Point at product.", "success");
            scanBtn.onclick = doScan;
        } catch (e) {
            setStatus("Init Error: " + e.message, "error");
        }
    }

    async function doScan() {
        scanBtn.disabled = true; scanBtn.textContent = "Scanning...";
        setStatus("Identifying product...", "loading");
        resultDiv.style.display = "none";

        try {
            // 1. Teachable Machine
            const canvas = document.createElement("canvas");
            canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(videoEl, 0, 0);

            const prediction = await tmModel.predict(canvas);
            const product = prediction.reduce((p, c) => p.probability > c.probability ? p : c).className;

            // 2. Gemini (Probeer modellen één voor één)
            setStatus(`Product: ${product}. Finding date...`, "loading");
            
            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            const base64Image = canvas.toDataURL("image/jpeg").split(",")[1];
            const imagePart = { inlineData: { data: base64Image, mimeType: "image/jpeg" } };
            const prompt = `This is a ${product}. Find the EXPIRATION DATE (EXP/BB/THT). Reply ONLY with the date (e.g. "12 Oct 2025"). If NO date found, reply "NULL".`;

            let text = "NULL";
            let success = false;

            // --- DE MAGISCHE LOOP DIE DE ERROR OPLOST ---
            for (const modelName of MODEL_NAMES) {
                try {
                    console.log("Trying model:", modelName);
                    const model = genAI.getGenerativeModel({ model: modelName });
                    const result = await model.generateContent([prompt, imagePart]);
                    text = (await result.response.text()).trim();
                    success = true;
                    break; // Het is gelukt! Stop met proberen.
                } catch (err) {
                    console.warn(`Model ${modelName} failed, trying next...`, err);
                }
            }

            if (!success) throw new Error("All AI models failed. Check API Key/Network.");

            const found = !text.includes("NULL");
            resultContent.innerHTML = `<strong>Product:</strong> ${product}<br><strong>Date:</strong> ${found ? text : "Not found"}`;
            resultDiv.style.display = "block";
            
            setStatus(found ? "Success!" : "No date found", found ? "success" : "error");
            speak(found ? `Product is ${product}. Date is ${text}` : `Product is ${product}. No date found.`);

        } catch (e) {
            setStatus("Error: " + e.message, "error");
        }
        scanBtn.disabled = false; scanBtn.textContent = "SCAN AGAIN";
    }

    init();
</script>
</body>
</html>
