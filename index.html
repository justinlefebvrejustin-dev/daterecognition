<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Scanner RAW</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <style>
        body { font-family: -apple-system, sans-serif; background: #222; display: flex; flex-direction: column; align-items: center; padding: 20px; color: white; }
        .container { background: #333; padding: 20px; border-radius: 12px; width: 100%; max-width: 500px; text-align: center; }
        h1 { margin-bottom: 10px; color: #fff; }
        video { width: 100%; border-radius: 8px; background: black; margin-bottom: 15px; transform: scaleX(-1); border: 2px solid #555; }
        button { background: #007bff; color: white; border: none; padding: 18px 30px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background: #555; cursor: not-allowed; }
        .status { margin: 15px 0; padding: 12px; border-radius: 8px; font-weight: 500; font-family: monospace; }
        .status.loading { background: #444; color: #ccc; }
        .status.success { background: #1b5e20; color: #fff; }
        .status.error { background: #b71c1c; color: #fff; }
        #result { margin-top: 20px; text-align: left; display: none; background: #444; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Date Scanner RAW</h1>
    <div id="status" class="status loading">Initializing...</div>
    <div style="position: relative;"><video id="video" autoplay playsinline muted></video></div>
    <button id="scanBtn" disabled>Loading Models...</button>
    <div id="result"></div>
</div>

<script>
    // CONFIGURATIE
    const TM_MODEL_URL = "https://teachablemachine.withgoogle.com/models/hgp4ntk2z/";
    const API_KEY = "AIzaSyCO2VXgEzZyE7ox-eXeTwP5VIb79w3eKp8"; 
    
    // We gebruiken GEEN bibliotheek meer, maar de directe link.
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

    let tmModel, videoEl = document.getElementById('video');
    let statusEl = document.getElementById('status');
    let scanBtn = document.getElementById('scanBtn');
    let resultDiv = document.getElementById('result');

    function setStatus(msg, type='loading') {
        statusEl.textContent = msg;
        statusEl.className = `status ${type}`;
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }

    async function init() {
        try {
            tmModel = await tmImage.load(TM_MODEL_URL + 'model.json', TM_MODEL_URL + 'metadata.json');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            videoEl.srcObject = stream;
            
            scanBtn.disabled = false;
            scanBtn.textContent = "SCAN PRODUCT";
            setStatus("System Ready. Mode: RAW API", "success");
            scanBtn.onclick = doScan;
        } catch (e) {
            setStatus("Init Error: " + e.message, "error");
        }
    }

    async function doScan() {
        scanBtn.disabled = true; scanBtn.textContent = "Scanning...";
        setStatus("Identifying product...", "loading");
        resultDiv.style.display = "none";

        try {
            // 1. Teachable Machine
            const canvas = document.createElement("canvas");
            canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(videoEl, 0, 0);

            const prediction = await tmModel.predict(canvas);
            const product = prediction.reduce((p, c) => p.probability > c.probability ? p : c).className;

            setStatus(`Product: ${product}. Sending to Google...`, "loading");

            // 2. Gemini via RAW FETCH (Geen libraries!)
            const base64Image = canvas.toDataURL("image/jpeg").split(",")[1];
            
            const payload = {
                contents: [{
                    parts: [
                        { text: `You are an assistant for the blind. This is a ${product}. Find the EXPIRATION DATE (EXP/BB/THT). Reply ONLY with the date (e.g. "12 Oct 2025"). If NO date found, reply "NULL".` },
                        { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                    ]
                }]
            };

            const response = await fetch(GEMINI_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || "Google API Error");
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "NULL";
            const found = !text.includes("NULL");

            resultDiv.innerHTML = `<strong>Product:</strong> ${product}<br><strong>Date:</strong> ${found ? text : "Not found"}`;
            resultDiv.style.display = "block";
            
            setStatus(found ? "Success!" : "No date found", found ? "success" : "error");
            speak(found ? `Product is ${product}. Date is ${text}` : `Product is ${product}. No date found.`);

        } catch (e) {
            setStatus("Scan Error: " + e.message, "error");
            console.error(e);
        }
        scanBtn.disabled = false; scanBtn.textContent = "SCAN AGAIN";
    }

    init();
</script>
</body>
</html>
